{% extends "base.html" %}

{% block title %}{{ t('Activités') }} - Garmin Tracker{% endblock %}

{% block head_extra %}
  <link rel="stylesheet" href="{{ url_for('static', filename='activity.css') }}">
  <script defer src="{{ url_for('static', filename='progress.js') }}"></script>
  <script defer src="{{ url_for('static', filename='activity_tabs.js') }}"></script>
{% endblock %}

{% block content %}
  <div class="activity-header">
    <h1 style="margin: 0;">{{ t('Activités') }}</h1>
      <form method="post" action="{{ url_for('update_activity') }}" class="sync-form">
      <input name="garmin_password" type="password" placeholder="{{ t('Mot de passe Garmin') }}" required style="min-width: 220px;" />
      <button class="btn" type="submit">{{ t('Mettre à jour') }}</button>
    </form>
  </div>

  {% if task_id and task_status_url %}
    <div class="card card--muted" id="task-progress" data-status-url="{{ task_status_url }}" data-redirect-url="{{ url_for('activity', user=viewing_user_id) }}">
      <div style="display: flex; align-items: center; justify-content: space-between; gap: 12px;">
        <strong>{{ t('Mise à jour en cours') }}</strong>
        <span class="muted" data-progress-percent>0%</span>
      </div>
      <div style="height: 10px;"></div>
      <div class="progress"><div class="progress__bar" data-progress-bar></div></div>
      <div class="muted" style="margin-top: 10px;" data-progress-message>…</div>
      <div class="muted" style="margin-top: 6px; color: var(--accent2);" data-progress-error></div>
    </div>

    <div style="height: 12px;"></div>
  {% endif %}

  <section class="card" aria-label="Activités">
    <h2 style="margin-top: 0;">{{ t('Par sport') }}</h2>
    <div class="muted" style="margin-top: -8px; margin-bottom: 12px;">{{ t('Natation • Vélo • Course à pied • Musculation') }}</div>

    {% if not sport_tabs %}
      <div class="muted">{{ t('Aucune activité disponible. Clique sur “Mettre à jour”.') }}</div>
    {% else %}
      <div class="tabs" data-tabs data-active-tab="{{ active_tab or '' }}">
        {% for tab in sport_tabs %}
          <button type="button" class="tab-btn" data-tab-button="{{ tab.type_key }}" aria-selected="false">
            {{ tab.type_label }}
          </button>
        {% endfor %}
      </div>

      <div style="height: 12px;"></div>

      {% for tab in sport_tabs %}
        <div class="tab-panel" data-tab-panel="{{ tab.type_key }}">
          {% if tab.graphs %}
            <section class="graph-grid" aria-label="Graphiques {{ tab.type_label }}">
              {% for src in tab.graphs %}
                <iframe class="graph-frame" loading="lazy" src="{{ src }}"></iframe>
              {% endfor %}
            </section>
            <div style="height: 12px;"></div>
          {% else %}
            <div class="card card--muted">
              <strong>{{ t('Graphiques indisponibles') }}</strong>
              <div class="muted">{{ t('Synchronise pour générer les graphes.') }}</div>
            </div>
            <div style="height: 12px;"></div>
          {% endif %}

          {% if tab.activities %}
            <div class="activity-scroll">
              <ul class="activity-items">
                {% for a in tab.activities %}
                  {% set rpe_val = a.get('rpe') %}
                  {% set bg_style = '' %}
                  {% if rpe_val is not none %}
                    {% if rpe_val <= 3 %}
                      {% set bg_style = 'background: rgba(34, 197, 94, 0.08);' %}
                    {% elif rpe_val <= 6 %}
                      {% set bg_style = 'background: rgba(234, 179, 8, 0.08);' %}
                    {% else %}
                      {% set bg_style = 'background: rgba(239, 68, 68, 0.08);' %}
                    {% endif %}
                  {% else %}
                    {% set bg_style = 'background: rgba(255, 255, 255, 0.02);' %}
                  {% endif %}
                  <li class="activity-item" style="{{ bg_style }}">
                    {% if a.activity_id %}
                      <a class="activity-link" href="{{ url_for('activity_detail', activity_id=a.activity_id, user=viewing_user_id) }}">
                        <div class="activity-item__date">{{ a.date }}</div>
                        <div class="activity-item__meta">
                          <span style="font-weight: 800; color: var(--text);">{{ a.name }}</span>
                          {% if a.distance and a.distance > 0 %}<span>{{ a.distance }} km</span>{% endif %}
                          <span>{{ a.duration }}</span>
                          {% if a.avg_pace %}<span>{{ a.avg_pace }}</span>{% endif %}
                        </div>
                        {% if a.planned %}
                          <div class="muted" style="margin-top: 8px;">
                            {{ t('Planifié') }}: <strong style="color: var(--text);">{{ a.planned.title }}</strong>
                            {% if a.planned.description %}
                              — {{ a.planned.description|truncate(140, True, '…') }}
                            {% elif a.planned.content %}
                              — {{ a.planned.content|replace('\n', ' ')|truncate(140, True, '…') }}
                            {% endif %}
                            {% if a.planned.id %}
                              <span>• <a href="{{ url_for('training_detail', training_id=a.planned.id, user=viewing_user_id) }}">{{ t('Voir séance') }}</a></span>
                            {% endif %}
                          </div>
                        {% endif %}
                      </a>
                    {% else %}
                      <div class="activity-item__date">{{ a.date }}</div>
                      <div class="activity-item__meta">
                        <span style="font-weight: 800; color: var(--text);">{{ a.name }}</span>
                        {% if a.distance and a.distance > 0 %}<span>{{ a.distance }} km</span>{% endif %}
                        <span>{{ a.duration }}</span>
                        {% if a.avg_pace %}<span>{{ a.avg_pace }}</span>{% endif %}
                      </div>
                    {% endif %}
                  </li>
                {% endfor %}
              </ul>
            </div>
          {% else %}
            <div class="muted">{{ t('Aucune activité pour ce sport sur la période.') }}</div>
          {% endif %}
        </div>
      {% endfor %}
    {% endif %}
  </section>
{% endblock %}
